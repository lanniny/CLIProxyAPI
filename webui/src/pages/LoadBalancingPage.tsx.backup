/**
 * Load Balancing Page - Manages credential weights, health status, and circuit breakers
 */

import { useCallback, useEffect, useState } from 'react';
import { useTranslation } from 'react-i18next';
import { useHeaderRefresh } from '@/hooks/useHeaderRefresh';
import { useAuthStore, useNotificationStore } from '@/stores';
import { loadBalancingApi } from '@/services/api';
import { Button } from '@/components/ui/Button';
import type {
  CredentialWeight,
  HealthStatus,
  CircuitBreakerStatus,
} from '@/services/api/loadBalancing';
import styles from './LoadBalancingPage.module.scss';

type TabType = 'weights' | 'health' | 'circuit-breaker';

export function LoadBalancingPage() {
  const { t } = useTranslation();
  const { showNotification } = useNotificationStore();
  const connectionStatus = useAuthStore((state) => state.connectionStatus);

  const [activeTab, setActiveTab] = useState<TabType>('weights');
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  // Credential weights state
  const [weights, setWeights] = useState<CredentialWeight[]>([]);
  const [editingWeights, setEditingWeights] = useState<Record<string, number>>({});
  const [savingWeights, setSavingWeights] = useState(false);

  // Health status state
  const [healthStatus, setHealthStatus] = useState<HealthStatus[]>([]);

  // Circuit breaker state
  const [circuitBreakers, setCircuitBreakers] = useState<CircuitBreakerStatus[]>([]);
  const [resettingBreaker, setResettingBreaker] = useState<string | null>(null);

  const disableControls = connectionStatus !== 'connected';

  const loadWeights = useCallback(async () => {
    try {
      const data = await loadBalancingApi.getCredentialWeights();
      setWeights(data);
      // Initialize editing weights
      const initial: Record<string, number> = {};
      data.forEach((w) => {
        initial[w.auth_id] = w.weight;
      });
      setEditingWeights(initial);
    } catch (err: unknown) {
      console.error('Failed to load weights:', err);
    }
  }, []);

  const loadHealthStatus = useCallback(async () => {
    try {
      const data = await loadBalancingApi.getHealthStatus();
      setHealthStatus(data);
    } catch (err: unknown) {
      console.error('Failed to load health status:', err);
    }
  }, []);

  const loadCircuitBreakers = useCallback(async () => {
    try {
      const data = await loadBalancingApi.getCircuitBreakerStatus();
      setCircuitBreakers(data);
    } catch (err: unknown) {
      console.error('Failed to load circuit breakers:', err);
    }
  }, []);

  const loadAllData = useCallback(async () => {
    setLoading(true);
    setError('');
    try {
      await Promise.all([loadWeights(), loadHealthStatus(), loadCircuitBreakers()]);
    } catch (err: unknown) {
      const errorMessage = err instanceof Error ? err.message : t('notification.refresh_failed');
      setError(errorMessage);
    } finally {
      setLoading(false);
    }
  }, [loadWeights, loadHealthStatus, loadCircuitBreakers, t]);

  const handleHeaderRefresh = useCallback(async () => {
    await loadAllData();
  }, [loadAllData]);

  useHeaderRefresh(handleHeaderRefresh);

  useEffect(() => {
    loadAllData();
  }, [loadAllData]);

  const handleWeightChange = (authId: string, value: string) => {
    const numValue = parseInt(value, 10);
    if (!isNaN(numValue) && numValue >= 0) {
      setEditingWeights((prev) => ({ ...prev, [authId]: numValue }));
    }
  };

  const handleSaveWeights = async () => {
    setSavingWeights(true);
    try {
      const updates = Object.entries(editingWeights)
        .filter(([authId, weight]) => {
          const original = weights.find((w) => w.auth_id === authId);
          return original && original.weight !== weight;
        })
        .map(([auth_id, weight]) => ({ auth_id, weight }));

      if (updates.length === 0) {
        showNotification(t('load_balancing.no_changes'), 'info');
        return;
      }

      await loadBalancingApi.updateCredentialWeights(updates);
      await loadWeights();
      showNotification(t('load_balancing.weights_saved'), 'success');
    } catch (err: unknown) {
      const errorMessage = err instanceof Error ? err.message : t('notification.update_failed');
      showNotification(`${t('notification.update_failed')}: ${errorMessage}`, 'error');
    } finally {
      setSavingWeights(false);
    }
  };

  const handleResetCircuitBreaker = async (authId: string) => {
    setResettingBreaker(authId);
    try {
      await loadBalancingApi.resetCircuitBreaker(authId);
      await loadCircuitBreakers();
      showNotification(t('load_balancing.circuit_breaker_reset'), 'success');
    } catch (err: unknown) {
      const errorMessage = err instanceof Error ? err.message : t('notification.update_failed');
      showNotification(`${t('notification.update_failed')}: ${errorMessage}`, 'error');
    } finally {
      setResettingBreaker(null);
    }
  };

  const formatTimeAgo = (dateStr: string | null) => {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);

    if (diffSec < 60) return `${diffSec}s ago`;
    if (diffMin < 60) return `${diffMin}m ago`;
    if (diffHour < 24) return `${diffHour}h ago`;
    return date.toLocaleDateString();
  };

  const getCircuitBreakerStateClass = (state: string) => {
    switch (state) {
      case 'closed':
        return styles.statusClosed;
      case 'open':
        return styles.statusOpen;
      case 'half-open':
        return styles.statusHalfOpen;
      default:
        return '';
    }
  };

  const hasWeightChanges = () => {
    return Object.entries(editingWeights).some(([authId, weight]) => {
      const original = weights.find((w) => w.auth_id === authId);
      return original && original.weight !== weight;
    });
  };

  const renderWeightsTab = () => (
    <div className={styles.section}>
      <div className={styles.sectionHeader}>
        <h2 className={styles.sectionTitle}>
          <svg className={styles.sectionTitleIcon} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M12 3v18M3 12h18M5.5 8.5l13 7M5.5 15.5l13-7" />
          </svg>
          {t('load_balancing.credential_weights')}
        </h2>
        <div className={styles.sectionActions}>
          <Button
            size="sm"
            onClick={handleSaveWeights}
            loading={savingWeights}
            disabled={disableControls || !hasWeightChanges()}
          >
            {t('common.save')}
          </Button>
          <Button
            size="sm"
            variant="secondary"
            onClick={loadWeights}
            disabled={disableControls}
          >
            {t('common.refresh')}
          </Button>
        </div>
      </div>
      <div className={styles.sectionContent}>
        {weights.length === 0 ? (
          <div className={styles.emptyState}>
            <div className={styles.emptyTitle}>{t('load_balancing.no_credentials')}</div>
            <div className={styles.emptyDesc}>{t('load_balancing.no_credentials_desc')}</div>
          </div>
        ) : (
          <div className={styles.grid}>
            {weights.map((cred) => (
              <div key={cred.auth_id} className={styles.card}>
                <div className={styles.cardHeader}>
                  <div className={styles.cardTitle}>{cred.display_name || cred.auth_id}</div>
                  <span className={styles.cardProvider}>{cred.provider}</span>
                </div>
                <div className={styles.cardBody}>
                  <div className={styles.cardRow}>
                    <span className={styles.cardLabel}>{t('load_balancing.weight')}:</span>
                    <input
                      type="number"
                      min="0"
                      className={styles.weightInput}
                      value={editingWeights[cred.auth_id] ?? cred.weight}
                      onChange={(e) => handleWeightChange(cred.auth_id, e.target.value)}
                      disabled={disableControls || cred.disabled}
                    />
                  </div>
                  <div className={styles.cardRow}>
                    <span className={styles.cardLabel}>{t('load_balancing.status')}:</span>
                    <span className={`${styles.statusBadge} ${cred.disabled ? styles.statusDisabled : styles.statusHealthy}`}>
                      {cred.disabled ? t('load_balancing.disabled') : t('load_balancing.enabled')}
                    </span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );

  const renderHealthTab = () => (
    <div className={styles.section}>
      <div className={styles.sectionHeader}>
        <h2 className={styles.sectionTitle}>
          <svg className={styles.sectionTitleIcon} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
          </svg>
          {t('load_balancing.health_status')}
        </h2>
        <div className={styles.sectionActions}>
          <Button
            size="sm"
            variant="secondary"
            onClick={loadHealthStatus}
            disabled={disableControls}
          >
            {t('common.refresh')}
          </Button>
        </div>
      </div>
      <div className={styles.sectionContent}>
        {healthStatus.length === 0 ? (
          <div className={styles.emptyState}>
            <div className={styles.emptyTitle}>{t('load_balancing.no_health_data')}</div>
            <div className={styles.emptyDesc}>{t('load_balancing.no_health_data_desc')}</div>
          </div>
        ) : (
          <div className={styles.grid}>
            {healthStatus.map((status) => (
              <div key={status.auth_id} className={styles.card}>
                <div className={styles.cardHeader}>
                  <div className={styles.cardTitle}>{status.display_name || status.auth_id}</div>
                  <span className={styles.cardProvider}>{status.provider}</span>
                </div>
                <div className={styles.cardBody}>
                  <div className={styles.cardRow}>
                    <span className={styles.cardLabel}>{t('load_balancing.health')}:</span>
                    <span className={`${styles.statusBadge} ${status.healthy ? styles.statusHealthy : styles.statusUnhealthy}`}>
                      <span className={`${styles.indicatorDot} ${status.healthy ? 'green' : 'red'}`} />
                      {status.healthy ? t('load_balancing.healthy') : t('load_balancing.unhealthy')}
                    </span>
                  </div>
                  <div className={styles.cardRow}>
                    <span className={styles.cardLabel}>{t('load_balancing.last_check')}:</span>
                    <span className={styles.timeAgo}>{formatTimeAgo(status.last_check)}</span>
                  </div>
                  {status.consecutive_failures > 0 && (
                    <div className={styles.cardRow}>
                      <span className={styles.cardLabel}>{t('load_balancing.failures')}:</span>
                      <span className={styles.cardValue}>{status.consecutive_failures}</span>
                    </div>
                  )}
                  {status.last_error && (
                    <div className={styles.errorMessage}>{status.last_error}</div>
                  )}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );

  const renderCircuitBreakerTab = () => (
    <div className={styles.section}>
      <div className={styles.sectionHeader}>
        <h2 className={styles.sectionTitle}>
          <svg className={styles.sectionTitleIcon} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 6v6l4 2" />
          </svg>
          {t('load_balancing.circuit_breakers')}
        </h2>
        <div className={styles.sectionActions}>
          <Button
            size="sm"
            variant="secondary"
            onClick={loadCircuitBreakers}
            disabled={disableControls}
          >
            {t('common.refresh')}
          </Button>
        </div>
      </div>
      <div className={styles.sectionContent}>
        {circuitBreakers.length === 0 ? (
          <div className={styles.emptyState}>
            <div className={styles.emptyTitle}>{t('load_balancing.no_circuit_breakers')}</div>
            <div className={styles.emptyDesc}>{t('load_balancing.no_circuit_breakers_desc')}</div>
          </div>
        ) : (
          <div className={styles.grid}>
            {circuitBreakers.map((cb) => (
              <div key={cb.auth_id} className={styles.card}>
                <div className={styles.cardHeader}>
                  <div className={styles.cardTitle}>{cb.display_name || cb.auth_id}</div>
                  <span className={styles.cardProvider}>{cb.provider}</span>
                </div>
                <div className={styles.cardBody}>
                  <div className={styles.cardRow}>
                    <span className={styles.cardLabel}>{t('load_balancing.state')}:</span>
                    <span className={`${styles.statusBadge} ${getCircuitBreakerStateClass(cb.state)}`}>
                      <span className={`${styles.indicatorDot} ${cb.state === 'closed' ? 'green' : cb.state === 'open' ? 'red' : 'yellow'}`} />
                      {cb.state.toUpperCase()}
                    </span>
                  </div>
                  <div className={styles.cardRow}>
                    <span className={styles.cardLabel}>{t('load_balancing.failure_count')}:</span>
                    <span className={styles.cardValue}>{cb.failure_count}</span>
                  </div>
                  <div className={styles.cardRow}>
                    <span className={styles.cardLabel}>{t('load_balancing.success_count')}:</span>
                    <span className={styles.cardValue}>{cb.success_count}</span>
                  </div>
                  {cb.last_failure && (
                    <div className={styles.cardRow}>
                      <span className={styles.cardLabel}>{t('load_balancing.last_failure')}:</span>
                      <span className={styles.timeAgo}>{formatTimeAgo(cb.last_failure)}</span>
                    </div>
                  )}
                  {cb.state === 'open' && cb.next_retry && (
                    <div className={styles.cardRow}>
                      <span className={styles.cardLabel}>{t('load_balancing.next_retry')}:</span>
                      <span className={styles.timeAgo}>{formatTimeAgo(cb.next_retry)}</span>
                    </div>
                  )}
                </div>
                {cb.state !== 'closed' && (
                  <div className={styles.cardActions}>
                    <Button
                      size="sm"
                      variant="secondary"
                      onClick={() => handleResetCircuitBreaker(cb.auth_id)}
                      loading={resettingBreaker === cb.auth_id}
                      disabled={disableControls}
                    >
                      {t('load_balancing.reset')}
                    </Button>
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );

  return (
    <div className={styles.container}>
      <div className={styles.pageHeader}>
        <h1 className={styles.pageTitle}>{t('load_balancing.title')}</h1>
        <p className={styles.description}>{t('load_balancing.description')}</p>
      </div>

      {error && <div className={styles.errorBox}>{error}</div>}

      <div className={styles.section}>
        <div className={styles.tabs}>
          <button
            className={`${styles.tab} ${activeTab === 'weights' ? styles.active : ''}`}
            onClick={() => setActiveTab('weights')}
          >
            {t('load_balancing.tab_weights')}
          </button>
          <button
            className={`${styles.tab} ${activeTab === 'health' ? styles.active : ''}`}
            onClick={() => setActiveTab('health')}
          >
            {t('load_balancing.tab_health')}
          </button>
          <button
            className={`${styles.tab} ${activeTab === 'circuit-breaker' ? styles.active : ''}`}
            onClick={() => setActiveTab('circuit-breaker')}
          >
            {t('load_balancing.tab_circuit_breaker')}
          </button>
        </div>
      </div>

      {loading ? (
        <div className={styles.loading}>{t('common.loading')}</div>
      ) : (
        <>
          {activeTab === 'weights' && renderWeightsTab()}
          {activeTab === 'health' && renderHealthTab()}
          {activeTab === 'circuit-breaker' && renderCircuitBreakerTab()}
        </>
      )}
    </div>
  );
}
